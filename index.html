<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸ç§å®æ—¶ç›‘æ§ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 10px;
            transform-origin: top left;
            transition: transform 0.3s ease;
        }
        
        .container {
            max-width: 2000px;
            margin: 0 auto;
            width: 100%;
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: clamp(1.6rem, 3.5vw, 2.2rem);
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
            opacity: 0.9;
        }
        
        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-3px);
        }
        
        .stats-number {
            font-size: clamp(1.6rem, 3.5vw, 2.2rem);
            font-weight: bold;
            color: #1a2a6c;
            margin: 5px 0;
        }
        
        .stats-label {
            font-size: clamp(0.8rem, 1.3vw, 0.9rem);
            color: #666;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: clamp(0.8rem, 1.3vw, 0.9rem);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }
        
        #start-btn {
            background: #2e7d32;
            color: white;
        }
        
        #start-btn:hover {
            background: #1b5e20;
        }
        
        #stop-btn {
            background: #c62828;
            color: white;
        }
        
        #stop-btn:hover {
            background: #b71c1c;
        }
        
        #stop-btn:disabled, #start-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            font-weight: bold;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #c62828;
        }
        
        .status-dot.active {
            background: #2e7d32;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .currency-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }
        
        .currency-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: clamp(0.75rem, 1.2vw, 0.85rem);
        }
        
        .currency-table th {
            background: #1a2a6c;
            color: white;
            padding: 8px 6px;
            text-align: left;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
            font-size: clamp(0.75rem, 1.2vw, 0.85rem);
            font-weight: 600;
        }
        
        .currency-table th:hover {
            background: #0d1a4a;
        }
        
        .currency-table td {
            padding: 6px 5px;
            border-bottom: 1px solid #eee;
            line-height: 1.2;
        }
        
        .currency-table tr:hover {
            background: rgba(26, 42, 108, 0.05);
        }
        
        .currency-link {
            color: #1a2a6c;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
            font-size: clamp(0.75rem, 1.2vw, 0.85rem);
        }
        
        .currency-link:hover {
            color: #0d1a4a;
            text-decoration: underline;
        }
        
        .positive {
            color: #2e7d32;
            font-weight: bold;
        }
        
        .negative {
            color: #c62828;
            font-weight: bold;
        }
        
        /* ä¿®æ”¹ç®­å¤´æ ·å¼ */
        .change-indicator {
            margin-left: 3px;
            font-weight: bold;
        }
        
        .change-indicator.up {
            color: #2e7d32;
            font-size: 1.2em; /* æ›´å¤§çš„ä¸Šå‡ç®­å¤´ */
        }
        
        .change-indicator.down {
            color: #c62828;
            font-size: 0.9em; /* æ›´å°çš„ä¸‹é™ç®­å¤´ */
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: clamp(0.9rem, 1.5vw, 1rem);
        }
        
        .spinner {
            border: 4px solid rgba(26, 42, 108, 0.3);
            border-radius: 50%;
            border-top: 4px solid #1a2a6c;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #b21f1f;
            font-size: 0.95rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: clamp(0.7rem, 1.1vw, 0.8rem);
        }
        
        .last-update {
            margin-top: 10px;
            font-size: clamp(0.7rem, 1.1vw, 0.8rem);
            color: #666;
            text-align: right;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: clamp(0.7rem, 1.1vw, 0.8rem);
            color: #666;
        }
        
        .api-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #c62828;
        }
        
        .api-status-dot.connected {
            background: #2e7d32;
        }
        
        .log-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            max-height: 150px;
            overflow-y: auto;
        }
        
        .log-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #1a2a6c;
            font-size: clamp(0.8rem, 1.3vw, 0.9rem);
        }
        
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #eee;
            font-size: clamp(0.7rem, 1.1vw, 0.8rem);
            color: #666;
            line-height: 1.3;
        }
        
        .log-time {
            color: #999;
            font-size: clamp(0.65rem, 1vw, 0.75rem);
        }
        
        .section-title {
            font-size: clamp(1rem, 2vw, 1.3rem);
            font-weight: bold;
            color: #1a2a6c;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .zoom-controls {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 8px;
            z-index: 1000;
        }
        
        .zoom-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 50%;
            background: #1a2a6c;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .zoom-btn:hover {
            background: #0d1a4a;
        }

        /* æé†’çª—å£æ ·å¼ */
        .alert-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            backdrop-filter: blur(10px);
            border: 2px solid #ff6b6b;
            transition: all 0.3s ease;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .alert-panel.minimized {
            width: 40px;
            height: 40px;
            overflow: hidden;
        }

        .alert-panel.minimized .alert-header,
        .alert-panel.minimized .alert-controls,
        .alert-panel.minimized .alert-content {
            display: none;
        }

        .alert-header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 12px 15px;
            border-radius: 8px 8px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .alert-controls {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .threshold-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .threshold-label {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
        }

        .alert-content {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            padding: 10px;
        }

        .alert-item {
            padding: 8px 10px;
            margin-bottom: 8px;
            background: #fff;
            border-radius: 6px;
            border-left: 4px solid #ff6b6b;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        }

        .alert-item.new {
            background: #fff9e6;
            border-left-color: #ffc107;
        }

        .alert-currency {
            font-weight: bold;
            color: #1a2a6c;
            text-decoration: none;
            cursor: pointer;
        }

        .alert-currency:hover {
            text-decoration: underline;
        }

        .alert-change {
            font-weight: bold;
            margin: 3px 0;
        }

        .alert-time {
            font-size: 0.7rem;
            color: #999;
        }

        .alert-minimize {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 2px 8px;
            font-size: 1rem;
        }

        .alert-minimize:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ff6b6b;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .alert-history-count {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            padding: 5px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .blinking {
            animation: blink 1s infinite;
        }
        
        @media (max-width: 1200px) {
            .tables-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .status-indicator {
                margin-left: 0;
            }
            
            .zoom-controls {
                bottom: 8px;
                right: 8px;
            }
            
            .currency-table th,
            .currency-table td {
                padding: 5px 4px;
            }

            .alert-panel {
                width: 300px;
                left: 10px;
                top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- æé†’çª—å£ -->
    <div class="alert-panel" id="alertPanel">
        <div class="alert-header">
            <span>ğŸ“ˆ æ¶¨å¹…æé†’</span>
            <button class="alert-minimize" id="minimizeAlert">âˆ’</button>
        </div>
        <div class="alert-controls">
            <div class="threshold-control">
                <span class="threshold-label">3åˆ†é’Ÿ:</span>
                <input type="number" id="threeMinThreshold" class="threshold-input" value="7" min="0" max="100" step="0.1">
                <span class="threshold-label">%</span>
            </div>
            <div class="threshold-control">
                <span class="threshold-label">15åˆ†é’Ÿ:</span>
                <input type="number" id="fifteenMinThreshold" class="threshold-input" value="7" min="0" max="100" step="0.1">
                <span class="threshold-label">%</span>
            </div>
            <button id="testAlert" style="margin-left: auto; padding: 4px 8px; font-size: 0.7rem;">æµ‹è¯•é“ƒå£°</button>
        </div>
        <div class="alert-content" id="alertContent">
            <div class="alert-item">
                <div>ç­‰å¾…æé†’...</div>
            </div>
        </div>
        <div class="alert-history-count" id="alertHistoryCount">ä»Šæ—¥æé†’: 0</div>
    </div>

    <div class="container">
        <header>
            <h1>å¸ç§å®æ—¶ç›‘æ§ç³»ç»Ÿ</h1>
            <p class="subtitle">å®æ—¶è¿½è¸ªå¸ç§ä»·æ ¼å˜åŒ–ï¼Œè®¡ç®—æ¶¨è·Œå¹…å’Œä¸Šæ¦œæ¬¡æ•°</p>
        </header>
        
        <div class="tables-container">
            <div class="currency-container">
                <div class="section-title">å®æ—¶æ¶¨å¹…æ’è¡Œæ¦œ</div>
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆå§‹åŒ–å¸ç§æ•°æ®...</p>
                </div>
                
                <div id="error" class="error" style="display: none;">
                    <h3>æ•°æ®åŠ è½½å¤±è´¥</h3>
                    <p id="error-message">æ— æ³•ä»APIè·å–æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</p>
                    <button onclick="initializeData()">
                        <i class="fas fa-sync-alt"></i>
                        é‡æ–°åŠ è½½
                    </button>
                </div>
                
                <div id="currency-content" style="display: none;">
                    <table class="currency-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>å¸ç§åç§°</th>
                                <th>å½“å‰ä»·æ ¼</th>
                                <th>1åˆ†é’Ÿæ¶¨å¹…</th>
                                <th>3åˆ†é’Ÿæ¶¨å¹…</th>
                                <th>æˆäº¤ç¬”æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="currency-table-body">
                            <!-- å¸ç§æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                    
                    <div class="last-update">
                        æœ€åæ›´æ–°: <span id="update-time">--</span>
                    </div>
                </div>
            </div>

            <div class="currency-container">
                <div class="section-title">15åˆ†é’Ÿä¸Šæ¦œç»Ÿè®¡</div>
                <div id="ranking-content" style="display: none;">
                    <table class="currency-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>å¸ç§åç§°</th>
                                <th>15åˆ†é’Ÿæ¶¨è·Œå¹…</th>
                                <th>ä¸Šæ¦œæ¬¡æ•°</th>
                                <th>æˆäº¤ç¬”æ•°æ€»å’Œ</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-table-body">
                            <!-- ä¸Šæ¦œç»Ÿè®¡æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                    
                    <div class="last-update">
                        ç»Ÿè®¡æ—¶é—´: <span id="ranking-update-time">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="stats-card">
                <h2>æœ‰äº¤æ˜“å¯¹å¸ç§</h2>
                <div id="trading-pairs-count" class="stats-number">--</div>
                <p class="stats-label">å½“å‰æœ‰äº¤æ˜“å¯¹çš„å¸ç§æ•°é‡</p>
            </div>
            
            <div class="stats-card">
                <h2>æ›´æ–°é¢‘ç‡</h2>
                <div class="stats-number">5ç§’</div>
                <p class="stats-label">æ•°æ®æ›´æ–°é—´éš”</p>
            </div>
            
            <div class="stats-card">
                <h2>æ•°æ®å­˜å‚¨</h2>
                <div class="stats-number">30åˆ†é’Ÿ</div>
                <p class="stats-label">ä»·æ ¼å†å²æ•°æ®å­˜å‚¨æ—¶é•¿</p>
            </div>
            
            <div class="stats-card">
                <h2>å¸ç§æ›´æ–°</h2>
                <div id="currency-refresh-countdown" class="stats-number">10:00</div>
                <p class="stats-label">ä¸‹æ¬¡å¸ç§åˆ—è¡¨æ›´æ–°</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-buttons">
                <button id="start-btn">
                    <i class="fas fa-play"></i>
                    å¼€å§‹ç›‘æ§
                </button>
                <button id="stop-btn" disabled>
                    <i class="fas fa-stop"></i>
                    åœæ­¢ç›‘æ§
                </button>
                <button id="refresh-currencies-btn">
                    <i class="fas fa-sync-alt"></i>
                    ç«‹å³æ›´æ–°å¸ç§
                </button>
            </div>
            
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="status-text">ç›‘æ§å·²åœæ­¢</span>
            </div>
            
            <div class="api-status">
                <div class="api-status-dot" id="api-status-dot"></div>
                <span id="api-status-text">APIçŠ¶æ€: æœªè¿æ¥</span>
            </div>
        </div>

        <div class="log-container">
            <div class="log-title">ç¨‹åºè¿è¡Œæ—¥å¿—</div>
            <div id="log-content">
                <!-- æ—¥å¿—å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <footer>
            <p>æ•°æ®æ¥æº: Binance API | å®æ—¶ç›‘æ§ç³»ç»Ÿ</p>
        </footer>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-out">-</button>
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-reset">â†º</button>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="alertSound" preload="auto">
        <source src="https://er-sycdn.kuwo.cn/43e24103b07cc05dd3ce6d25aa8374f8/69033ef1/resource/30106/trackmedia/M500000940im4R2Oo8.mp3?bitrate=128&from=vip" type="audio/mpeg">
    </audio>

    <script>
        // å…¨å±€å˜é‡
        let allCurrencies = [];
        let tradingPairsData = {};
        let priceHistory = {};
        let rankingHistory = []; // å­˜å‚¨15åˆ†é’Ÿå†…çš„ä¸Šæ¦œè®°å½•
        let fifteenMinuteHistory = {}; // å­˜å‚¨15åˆ†é’Ÿå‰çš„ä»·æ ¼æ•°æ®
        let previousThreeMinChanges = {}; // å­˜å‚¨ä¸Šä¸€æ¬¡çš„3åˆ†é’Ÿæ¶¨å¹…
        let previousFifteenMinChanges = {}; // å­˜å‚¨ä¸Šä¸€æ¬¡çš„15åˆ†é’Ÿæ¶¨å¹…
        let monitoringInterval = null;
        let currencyRefreshInterval = null;
        let isMonitoring = false;
        let apiRetryCount = 0;
        const MAX_RETRY_DISPLAY = 10;
        const DATA_RETENTION_MINUTES = 30;
        const TOP_RANK_COUNT = 20;
        const RANKING_WINDOW_MINUTES = 15; // ä¸Šæ¦œç»Ÿè®¡æ—¶é—´çª—å£
        const CURRENCY_REFRESH_MINUTES = 10; // å¸ç§åˆ—è¡¨æ›´æ–°é—´éš”
        let currentZoom = 1;
        let currencyRefreshCountdown = CURRENCY_REFRESH_MINUTES * 60; // 10åˆ†é’Ÿå€’è®¡æ—¶
        
        // æé†’ç›¸å…³å˜é‡
        let alertHistory = [];
        let alertSound = null;
        let soundTimeout = null;
        const ALERT_RETENTION_HOURS = 24; // æé†’è®°å½•ä¿ç•™24å°æ—¶

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            document.getElementById('start-btn').addEventListener('click', startMonitoring);
            document.getElementById('stop-btn').addEventListener('click', stopMonitoring);
            document.getElementById('refresh-currencies-btn').addEventListener('click', refreshCurrencies);
            
            // ç»‘å®šç¼©æ”¾æ§åˆ¶
            document.getElementById('zoom-in').addEventListener('click', zoomIn);
            document.getElementById('zoom-out').addEventListener('click', zoomOut);
            document.getElementById('zoom-reset').addEventListener('click', zoomReset);
            
            // ç»‘å®šæé†’æ§åˆ¶
            document.getElementById('minimizeAlert').addEventListener('click', toggleAlertPanel);
            document.getElementById('testAlert').addEventListener('click', testAlertSound);
            document.getElementById('threeMinThreshold').addEventListener('change', updateThresholds);
            document.getElementById('fifteenMinThreshold').addEventListener('change', updateThresholds);
            
            // åˆå§‹åŒ–éŸ³é¢‘
            initializeAlertSound();
            
            // åˆå§‹åŒ–å¯æ‹–æ‹½æé†’çª—å£
            initializeDraggableAlert();
            
            // å°è¯•ä»localStorageæ¢å¤çŠ¶æ€
            restoreStateFromStorage();
            
            // åˆå§‹åŒ–æ•°æ®
            initializeData();
            
            // å¯åŠ¨å¸ç§åˆ·æ–°å€’è®¡æ—¶
            startCurrencyRefreshCountdown();
            
            // æ›´æ–°æé†’å†å²æ˜¾ç¤º
            updateAlertHistoryCount();
        });

        // åˆå§‹åŒ–éŸ³é¢‘
        function initializeAlertSound() {
            alertSound = document.getElementById('alertSound');
            alertSound.volume = 1.0; // æœ€å¤§éŸ³é‡
        }

        // æµ‹è¯•é“ƒå£°
        function testAlertSound() {
            playAlertSound();
            addLog("æµ‹è¯•é“ƒå£°æ’­æ”¾");
        }

        // æ’­æ”¾æé†’é“ƒå£°
        function playAlertSound() {
            if (alertSound) {
                // åœæ­¢å½“å‰æ’­æ”¾
                alertSound.pause();
                alertSound.currentTime = 0;
                
                // å¼€å§‹æ’­æ”¾
                alertSound.play().catch(e => {
                    console.error('æ’­æ”¾é“ƒå£°å¤±è´¥:', e);
                    addLog('æ’­æ”¾é“ƒå£°å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘URL');
                });
                
                // 30ç§’ååœæ­¢
                clearTimeout(soundTimeout);
                soundTimeout = setTimeout(() => {
                    if (!alertSound.paused) {
                        alertSound.pause();
                        alertSound.currentTime = 0;
                    }
                }, 30000);
            }
        }

        // æ›´æ–°é˜ˆå€¼
        function updateThresholds() {
            addLog(`æé†’é˜ˆå€¼æ›´æ–°: 3åˆ†é’Ÿ=${getThreeMinThreshold()}%, 15åˆ†é’Ÿ=${getFifteenMinThreshold()}%`);
        }

        function getThreeMinThreshold() {
            return parseFloat(document.getElementById('threeMinThreshold').value) || 7;
        }

        function getFifteenMinThreshold() {
            return parseFloat(document.getElementById('fifteenMinThreshold').value) || 7;
        }

        // åˆ‡æ¢æé†’é¢æ¿æ˜¾ç¤º
        function toggleAlertPanel() {
            const panel = document.getElementById('alertPanel');
            panel.classList.toggle('minimized');
            
            if (panel.classList.contains('minimized')) {
                this.innerHTML = '+';
            } else {
                this.innerHTML = 'âˆ’';
            }
        }

        // åˆå§‹åŒ–å¯æ‹–æ‹½æé†’çª—å£
        function initializeDraggableAlert() {
            const panel = document.getElementById('alertPanel');
            const header = document.querySelector('.alert-header');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            function dragStart(e) {
                if (panel.classList.contains('minimized')) return;
                
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                if (e.target === header) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    setTranslate(currentX, currentY, panel);
                }
            }

            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }
        }

        // æ£€æŸ¥æ¶¨å¹…æé†’
        function checkPriceAlerts() {
            const threeMinThreshold = getThreeMinThreshold();
            const fifteenMinThreshold = getFifteenMinThreshold();
            let hasAlert = false;
            const currentAlerts = [];

            // æ£€æŸ¥å‰20åå¸ç§
            const top20Currencies = allCurrencies.slice(0, TOP_RANK_COUNT);
            
            top20Currencies.forEach(currency => {
                let alertType = null;
                let changeValue = 0;
                
                if (currency.threeMinChange >= threeMinThreshold) {
                    alertType = '3åˆ†é’Ÿ';
                    changeValue = currency.threeMinChange;
                } else if (currency.fifteenMinChange >= fifteenMinThreshold) {
                    alertType = '15åˆ†é’Ÿ';
                    changeValue = currency.fifteenMinChange;
                }
                
                if (alertType) {
                    hasAlert = true;
                    currentAlerts.push({
                        currency: currency,
                        type: alertType,
                        change: changeValue,
                        timestamp: new Date()
                    });
                }
            });

            // å¤„ç†æé†’
            if (hasAlert) {
                // æ’­æ”¾é“ƒå£°
                playAlertSound();
                
                // æ·»åŠ æé†’è®°å½•
                currentAlerts.forEach(alert => {
                    addAlertToHistory(alert);
                });
                
                // æ›´æ–°æ˜¾ç¤º
                updateAlertDisplay();
                
                addLog(`æ£€æµ‹åˆ° ${currentAlerts.length} ä¸ªå¸ç§æ¶¨å¹…è¶…è¿‡é˜ˆå€¼`);
            }
        }

        // æ·»åŠ æé†’åˆ°å†å²è®°å½•
        function addAlertToHistory(alert) {
            const alertRecord = {
                id: Date.now() + Math.random(),
                symbol: alert.currency.symbol,
                alphaId: alert.currency.alphaId,
                currencyLink: alert.currency.currencyLink,
                type: alert.type,
                change: alert.change,
                timestamp: alert.timestamp,
                isNew: true
            };
            
            // æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
            alertHistory.unshift(alertRecord);
            
            // æ¸…ç†è¶…è¿‡24å°æ—¶çš„è®°å½•
            const retentionTime = Date.now() - ALERT_RETENTION_HOURS * 60 * 60 * 1000;
            alertHistory = alertHistory.filter(record => record.timestamp >= retentionTime);
            
            // ä¿å­˜åˆ°localStorage
            saveAlertsToStorage();
        }

        // æ›´æ–°æé†’æ˜¾ç¤º
        function updateAlertDisplay() {
            const alertContent = document.getElementById('alertContent');
            alertContent.innerHTML = '';
            
            // æ˜¾ç¤ºæœ€æ–°çš„10æ¡æé†’
            const recentAlerts = alertHistory.slice(0, 10);
            
            if (recentAlerts.length === 0) {
                alertContent.innerHTML = '<div class="alert-item">ç­‰å¾…æé†’...</div>';
                return;
            }
            
            recentAlerts.forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = `alert-item ${alert.isNew ? 'new' : ''}`;
                
                const changeClass = alert.change >= 0 ? 'positive' : 'negative';
                const changeSign = alert.change >= 0 ? '+' : '';
                
                alertItem.innerHTML = `
                    <div>
                        <a href="${alert.currencyLink}" target="_blank" class="alert-currency">${alert.symbol}</a>
                        <div class="alert-change ${changeClass}">${alert.type}æ¶¨å¹…: ${changeSign}${alert.change.toFixed(4)}%</div>
                        <div class="alert-time">${alert.timestamp.toLocaleTimeString()}</div>
                    </div>
                `;
                
                alertContent.appendChild(alertItem);
                
                // æ ‡è®°ä¸ºå·²è¯»
                setTimeout(() => {
                    alert.isNew = false;
                }, 5000);
            });
            
            updateAlertHistoryCount();
        }

        // æ›´æ–°æé†’å†å²è®¡æ•°
        function updateAlertHistoryCount() {
            const today = new Date().toDateString();
            const todayAlerts = alertHistory.filter(alert => 
                alert.timestamp.toDateString() === today
            );
            document.getElementById('alertHistoryCount').textContent = `ä»Šæ—¥æé†’: ${todayAlerts.length}`;
        }

        // ä¿å­˜æé†’åˆ°localStorage
        function saveAlertsToStorage() {
            try {
                localStorage.setItem('alertHistory', JSON.stringify(alertHistory));
            } catch (error) {
                console.error('ä¿å­˜æé†’è®°å½•å¤±è´¥:', error);
            }
        }

        // ä»localStorageæ¢å¤æé†’è®°å½•
        function restoreAlertsFromStorage() {
            try {
                const savedAlerts = localStorage.getItem('alertHistory');
                if (savedAlerts) {
                    const alerts = JSON.parse(savedAlerts);
                    // è½¬æ¢æ—¶é—´æˆ³ä¸ºDateå¯¹è±¡
                    alertHistory = alerts.map(alert => ({
                        ...alert,
                        timestamp: new Date(alert.timestamp),
                        isNew: false
                    }));
                    
                    // æ¸…ç†è¿‡æœŸè®°å½•
                    const retentionTime = Date.now() - ALERT_RETENTION_HOURS * 60 * 60 * 1000;
                    alertHistory = alertHistory.filter(record => record.timestamp >= retentionTime);
                    
                    addLog(`æ¢å¤ ${alertHistory.length} æ¡æé†’è®°å½•`);
                    updateAlertDisplay();
                }
            } catch (error) {
                console.error('æ¢å¤æé†’è®°å½•å¤±è´¥:', error);
            }
        }

        // ä»localStorageæ¢å¤çŠ¶æ€
        function restoreStateFromStorage() {
            try {
                const savedState = localStorage.getItem('monitoringState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    
                    // æ¢å¤ç›‘æ§çŠ¶æ€
                    if (state.isMonitoring) {
                        setTimeout(() => {
                            startMonitoring();
                            addLog("æ£€æµ‹åˆ°ä¸Šæ¬¡ç›‘æ§çŠ¶æ€ï¼Œå·²è‡ªåŠ¨æ¢å¤ç›‘æ§");
                        }, 1000);
                    }
                    
                    // æ¢å¤æ’è¡Œæ¦œå†å²
                    if (state.rankingHistory && state.rankingHistory.length > 0) {
                        rankingHistory = state.rankingHistory;
                        addLog(`å·²æ¢å¤æ’è¡Œæ¦œå†å²æ•°æ®ï¼Œå…±${rankingHistory.length}æ¡è®°å½•`);
                    }
                    
                    // æ¢å¤ä»·æ ¼å†å²
                    if (state.priceHistory) {
                        priceHistory = state.priceHistory;
                    }
                    
                    // æ¢å¤15åˆ†é’Ÿå†å²
                    if (state.fifteenMinuteHistory) {
                        fifteenMinuteHistory = state.fifteenMinuteHistory;
                    }
                }

                // æ¢å¤æé†’è®°å½•
                restoreAlertsFromStorage();
                
            } catch (error) {
                console.error('æ¢å¤çŠ¶æ€å¤±è´¥:', error);
                addLog('æ¢å¤å†å²çŠ¶æ€å¤±è´¥ï¼Œå°†é‡æ–°å¼€å§‹');
            }
        }

        // ä¿å­˜çŠ¶æ€åˆ°localStorage
        function saveStateToStorage() {
            try {
                const state = {
                    isMonitoring: isMonitoring,
                    rankingHistory: rankingHistory,
                    priceHistory: priceHistory,
                    fifteenMinuteHistory: fifteenMinuteHistory,
                    lastSaved: Date.now()
                };
                localStorage.setItem('monitoringState', JSON.stringify(state));
            } catch (error) {
                console.error('ä¿å­˜çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // ç¼©æ”¾åŠŸèƒ½
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.1, 1.5);
            updateZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.1, 0.5);
            updateZoom();
        }

        function zoomReset() {
            currentZoom = 1;
            updateZoom();
        }

        function updateZoom() {
            document.body.style.transform = `scale(${currentZoom})`;
        }

        // å¸ç§åˆ·æ–°å€’è®¡æ—¶
        function startCurrencyRefreshCountdown() {
            setInterval(() => {
                currencyRefreshCountdown--;
                if (currencyRefreshCountdown <= 0) {
                    currencyRefreshCountdown = CURRENCY_REFRESH_MINUTES * 60;
                    refreshCurrencies();
                }
                updateCurrencyRefreshDisplay();
            }, 1000);
        }

        function updateCurrencyRefreshDisplay() {
            const minutes = Math.floor(currencyRefreshCountdown / 60);
            const seconds = currencyRefreshCountdown % 60;
            document.getElementById('currency-refresh-countdown').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // åˆ·æ–°å¸ç§æ•°æ®
        async function refreshCurrencies() {
            addLog("å¼€å§‹åˆ·æ–°å¸ç§åˆ—è¡¨æ•°æ®...");
            try {
                await fetchTradingPairs();
                await updateCurrencyData();
                currencyRefreshCountdown = CURRENCY_REFRESH_MINUTES * 60;
                updateCurrencyRefreshDisplay();
                addLog("å¸ç§åˆ—è¡¨æ•°æ®åˆ·æ–°å®Œæˆ");
            } catch (error) {
                addLog(`å¸ç§åˆ—è¡¨æ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°å¸ç§æ•°æ®ï¼ˆä¸é‡å¯ç¨‹åºï¼‰
        async function updateCurrencyData() {
            try {
                addLog("å¼€å§‹æ›´æ–°å¸ç§ä»·æ ¼æ•°æ®...");
                
                // è°ƒç”¨å¸å®‰API
                const response = await fetch('https://www.binance.com/bapi/defi/v1/public/wallet-direct/buw/wallet/cex/alpha/all/token/list');
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // æ£€æŸ¥APIè¿”å›çš„æ•°æ®ç»“æ„
                if (!data.data || !Array.isArray(data.data)) {
                    throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                // å¤„ç†æ•°æ® - åªä¿ç•™æœ‰äº¤æ˜“å¯¹çš„å¸ç§
                const newCurrencies = data.data
                    .filter(item => {
                        // åªä¿ç•™æœ‰äº¤æ˜“å¯¹çš„å¸ç§
                        return tradingPairsData[item.alphaId] && tradingPairsData[item.alphaId].length > 0;
                    })
                    .map(item => {
                        // ä½¿ç”¨APIè¿”å›çš„çœŸå®ä»·æ ¼
                        const price = item.price || "0.00000000000000";
                        
                        // ç”Ÿæˆå¸ç§é“¾æ¥
                        let currencyLink = "#";
                        if (item.chainName && item.contractAddress) {
                            const chainNameLower = item.chainName.toLowerCase();
                            currencyLink = `https://www.binance.com/zh-CN/alpha/${chainNameLower}/${item.contractAddress}`;
                        }
                        
                        // è·å–äº¤æ˜“å¯¹
                        const tradingPairs = tradingPairsData[item.alphaId] || [];
                        
                        // æŸ¥æ‰¾ç°æœ‰å¸ç§æ•°æ®
                        const existingCurrency = allCurrencies.find(c => c.alphaId === item.alphaId);
                        
                        return {
                            symbol: item.symbol || 'N/A',
                            alphaId: item.alphaId || 'N/A',
                            price: price,
                            currencyLink: currencyLink,
                            tradingPairs: tradingPairs,
                            oneMinChange: existingCurrency ? existingCurrency.oneMinChange : 0,
                            threeMinChange: existingCurrency ? existingCurrency.threeMinChange : 0,
                            threeMinChangeArrow: existingCurrency ? existingCurrency.threeMinChangeArrow : '',
                            fifteenMinChange: existingCurrency ? existingCurrency.fifteenMinChange : 0,
                            fifteenMinChangeArrow: existingCurrency ? existingCurrency.fifteenMinChangeArrow : '',
                            tradeCount: existingCurrency ? existingCurrency.tradeCount : 0
                        };
                    });
                
                // æ›´æ–°å¸ç§åˆ—è¡¨
                allCurrencies = newCurrencies;
                
                // æ›´æ–°ä»·æ ¼å†å²è®°å½•ä¸­çš„æ–°å¸ç§
                newCurrencies.forEach(currency => {
                    if (!priceHistory[currency.alphaId]) {
                        priceHistory[currency.alphaId] = {
                            timestamps: [Date.now()],
                            prices: [parseFloat(currency.price)]
                        };
                    }
                });
                
                // æ›´æ–°15åˆ†é’Ÿä»·æ ¼è®°å½•ä¸­çš„æ–°å¸ç§
                newCurrencies.forEach(currency => {
                    if (!fifteenMinuteHistory[currency.alphaId]) {
                        fifteenMinuteHistory[currency.alphaId] = {
                            timestamp: Date.now(),
                            price: parseFloat(currency.price)
                        };
                    }
                });
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStats();
                
                addLog(`å¸ç§æ•°æ®æ›´æ–°æˆåŠŸï¼Œå…±${allCurrencies.length}ä¸ªæœ‰äº¤æ˜“å¯¹çš„å¸ç§`);
                
            } catch (error) {
                addLog(`å¸ç§æ•°æ®æ›´æ–°å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // æ·»åŠ æ—¥å¿—å‡½æ•°ï¼ˆæœ€æ–°çš„æ—¥å¿—æ˜¾ç¤ºåœ¨æœ€ä¸Šé¢ï¼‰
        function addLog(message) {
            const logContent = document.getElementById('log-content');
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timeString}]</span> ${message}`;
            
            // æ’å…¥åˆ°æœ€å‰é¢
            if (logContent.firstChild) {
                logContent.insertBefore(logEntry, logContent.firstChild);
            } else {
                logContent.appendChild(logEntry);
            }
            
            // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œæœ€å¤šä¿ç•™50æ¡
            while (logContent.children.length > 50) {
                logContent.removeChild(logContent.lastChild);
            }
            
            console.log(`[${timeString}] ${message}`);
        }
        
        // åˆå§‹åŒ–æ•°æ®
        async function initializeData() {
            addLog("å¼€å§‹åˆå§‹åŒ–å¸ç§æ•°æ®...");
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('currency-content').style.display = 'none';
            document.getElementById('ranking-content').style.display = 'none';
            
            try {
                await fetchData();
            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
                addLog(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            }
        }
        
        // è·å–äº¤æ˜“å¯¹æ•°æ®
        async function fetchTradingPairs() {
            addLog("å¼€å§‹è·å–äº¤æ˜“å¯¹æ•°æ®...");
            
            let success = false;
            let retryCount = 0;
            
            while (!success) {
                try {
                    retryCount++;
                    if (retryCount > 1) {
                        addLog(`ç¬¬${retryCount}æ¬¡å°è¯•è·å–äº¤æ˜“å¯¹æ•°æ®...`);
                    }
                    
                    const response = await fetch('https://www.binance.com/bapi/defi/v1/public/alpha-trade/get-exchange-info');
                    
                    if (!response.ok) {
                        throw new Error(`äº¤æ˜“å¯¹APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.data || !Array.isArray(data.data.symbols)) {
                        throw new Error('äº¤æ˜“å¯¹APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    // å¤„ç†äº¤æ˜“å¯¹æ•°æ®
                    tradingPairsData = {};
                    data.data.symbols.forEach(symbol => {
                        if (symbol.status === 'TRADING' && symbol.baseAsset) {
                            const baseAsset = symbol.baseAsset;
                            if (!tradingPairsData[baseAsset]) {
                                tradingPairsData[baseAsset] = [];
                            }
                            tradingPairsData[baseAsset].push(symbol.symbol);
                        }
                    });
                    
                    success = true;
                    addLog(`äº¤æ˜“å¯¹æ•°æ®åŠ è½½æˆåŠŸï¼Œæœ‰äº¤æ˜“å¯¹çš„å¸ç§æ•°é‡: ${Object.keys(tradingPairsData).length}`);
                    
                } catch (error) {
                    addLog(`è·å–äº¤æ˜“å¯¹æ•°æ®å¤±è´¥: ${error.message}`);
                    console.error('è·å–äº¤æ˜“å¯¹æ•°æ®å¤±è´¥:', error);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
        
        // è·å–æ•°æ®ï¼ˆæ— é™é‡è¯•ç›´åˆ°æˆåŠŸï¼‰
        async function fetchData() {
            // å…ˆè·å–äº¤æ˜“å¯¹æ•°æ®
            await fetchTradingPairs();
            
            let success = false;
            
            while (!success) {
                try {
                    addLog("å¼€å§‹è·å–å¸ç§ä»·æ ¼æ•°æ®...");
                    
                    // è°ƒç”¨å¸å®‰API
                    const response = await fetch('https://www.binance.com/bapi/defi/v1/public/wallet-direct/buw/wallet/cex/alpha/all/token/list');
                    
                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // æ£€æŸ¥APIè¿”å›çš„æ•°æ®ç»“æ„
                    if (!data.data || !Array.isArray(data.data)) {
                        throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    // å¤„ç†æ•°æ® - åªä¿ç•™æœ‰äº¤æ˜“å¯¹çš„å¸ç§
                    allCurrencies = data.data
                        .filter(item => {
                            // åªä¿ç•™æœ‰äº¤æ˜“å¯¹çš„å¸ç§
                            return tradingPairsData[item.alphaId] && tradingPairsData[item.alphaId].length > 0;
                        })
                        .map(item => {
                            // ä½¿ç”¨APIè¿”å›çš„çœŸå®ä»·æ ¼
                            const price = item.price || "0.00000000000000";
                            
                            // ç”Ÿæˆå¸ç§é“¾æ¥
                            let currencyLink = "#";
                            if (item.chainName && item.contractAddress) {
                                const chainNameLower = item.chainName.toLowerCase();
                                currencyLink = `https://www.binance.com/zh-CN/alpha/${chainNameLower}/${item.contractAddress}`;
                            }
                            
                            // è·å–äº¤æ˜“å¯¹
                            const tradingPairs = tradingPairsData[item.alphaId] || [];
                            
                            return {
                                symbol: item.symbol || 'N/A',
                                alphaId: item.alphaId || 'N/A',
                                price: price,
                                currencyLink: currencyLink,
                                tradingPairs: tradingPairs,
                                oneMinChange: 0,
                                threeMinChange: 0,
                                threeMinChangeArrow: '',
                                fifteenMinChange: 0,
                                fifteenMinChangeArrow: '',
                                tradeCount: 0 // åˆå§‹åŒ–æˆäº¤ç¬”æ•°ä¸º0
                            };
                        });
                    
                    // åˆå§‹åŒ–ä»·æ ¼å†å²è®°å½•
                    initializePriceHistory();
                    
                    // åˆå§‹åŒ–15åˆ†é’Ÿä»·æ ¼è®°å½•
                    initializeFifteenMinuteHistory();
                    
                    // åˆå§‹åŒ–æ¶¨å¹…å˜åŒ–è®°å½•
                    initializeChangeHistory();
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateStats();
                    renderCurrencyTable();
                    updateRankingTable();
                    
                    // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('currency-content').style.display = 'block';
                    document.getElementById('ranking-content').style.display = 'block';
                    
                    // æ›´æ–°é¡µé¢æ—¶é—´
                    updateTime();
                    
                    // æ›´æ–°APIçŠ¶æ€
                    updateApiStatus(true);
                    apiRetryCount = 0;
                    
                    addLog(`å¸ç§æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${allCurrencies.length}ä¸ªæœ‰äº¤æ˜“å¯¹çš„å¸ç§`);
                    success = true;
                    
                } catch (error) {
                    apiRetryCount++;
                    const displayCount = Math.min(apiRetryCount, MAX_RETRY_DISPLAY);
                    
                    // æ›´æ–°APIçŠ¶æ€
                    updateApiStatus(false, `APIè¿æ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... (${displayCount}${apiRetryCount > MAX_RETRY_DISPLAY ? '+' : ''})`);
                    
                    addLog(`APIè¯·æ±‚å¤±è´¥ï¼Œç¬¬${apiRetryCount}æ¬¡é‡è¯•: ${error.message}`);
                    console.error(`APIè¯·æ±‚å¤±è´¥ï¼Œç¬¬${apiRetryCount}æ¬¡é‡è¯•:`, error);
                    
                    // ç­‰å¾…2ç§’åé‡è¯•
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
        
        // åˆå§‹åŒ–æ¶¨å¹…å˜åŒ–è®°å½•
        function initializeChangeHistory() {
            previousThreeMinChanges = {};
            previousFifteenMinChanges = {};
            
            allCurrencies.forEach(currency => {
                previousThreeMinChanges[currency.alphaId] = currency.threeMinChange;
                previousFifteenMinChanges[currency.alphaId] = currency.fifteenMinChange;
            });
        }
        
        // æ›´æ–°ç®­å¤´æŒ‡ç¤º - ä¿®æ”¹ä¸ºæ–°çš„ç®­å¤´æ ·å¼
        function updateChangeArrows() {
            allCurrencies.forEach(currency => {
                // æ›´æ–°3åˆ†é’Ÿæ¶¨å¹…ç®­å¤´ - ä½¿ç”¨æ–°çš„CSSç±»
                const prevThreeMin = previousThreeMinChanges[currency.alphaId] || 0;
                if (currency.threeMinChange > prevThreeMin) {
                    currency.threeMinChangeArrow = '<i class="fas fa-arrow-up change-indicator up"></i>';
                } else if (currency.threeMinChange < prevThreeMin) {
                    currency.threeMinChangeArrow = '<i class="fas fa-arrow-down change-indicator down"></i>';
                } else {
                    currency.threeMinChangeArrow = '';
                }
                
                // æ›´æ–°15åˆ†é’Ÿæ¶¨å¹…ç®­å¤´ - ä½¿ç”¨æ–°çš„CSSç±»
                const prevFifteenMin = previousFifteenMinChanges[currency.alphaId] || 0;
                if (currency.fifteenMinChange > prevFifteenMin) {
                    currency.fifteenMinChangeArrow = '<i class="fas fa-arrow-up change-indicator up"></i>';
                } else if (currency.fifteenMinChange < prevFifteenMin) {
                    currency.fifteenMinChangeArrow = '<i class="fas fa-arrow-down change-indicator down"></i>';
                } else {
                    currency.fifteenMinChangeArrow = '';
                }
                
                // æ›´æ–°å†å²è®°å½•
                previousThreeMinChanges[currency.alphaId] = currency.threeMinChange;
                previousFifteenMinChanges[currency.alphaId] = currency.fifteenMinChange;
            });
        }
        
        // åˆå§‹åŒ–15åˆ†é’Ÿä»·æ ¼å†å²è®°å½•
        function initializeFifteenMinuteHistory() {
            const now = Date.now();
            fifteenMinuteHistory = {};
            
            allCurrencies.forEach(currency => {
                fifteenMinuteHistory[currency.alphaId] = {
                    timestamp: now,
                    price: parseFloat(currency.price)
                };
            });
        }
        
        // æ›´æ–°15åˆ†é’Ÿä»·æ ¼å†å²è®°å½•
        function updateFifteenMinuteHistory() {
            const now = Date.now();
            const fifteenMinutesAgo = now - RANKING_WINDOW_MINUTES * 60 * 1000;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°15åˆ†é’Ÿå‰çš„ä»·æ ¼
            let needsUpdate = false;
            for (const alphaId in fifteenMinuteHistory) {
                if (fifteenMinuteHistory[alphaId].timestamp <= fifteenMinutesAgo) {
                    needsUpdate = true;
                    break;
                }
            }
            
            if (needsUpdate) {
                // æ›´æ–°æ‰€æœ‰å¸ç§çš„15åˆ†é’Ÿå‰ä»·æ ¼
                allCurrencies.forEach(currency => {
                    if (priceHistory[currency.alphaId] && priceHistory[currency.alphaId].timestamps.length > 0) {
                        // æŸ¥æ‰¾15åˆ†é’Ÿå‰çš„ä»·æ ¼
                        let fifteenMinPrice = null;
                        for (let i = priceHistory[currency.alphaId].timestamps.length - 1; i >= 0; i--) {
                            if (priceHistory[currency.alphaId].timestamps[i] <= fifteenMinutesAgo) {
                                fifteenMinPrice = priceHistory[currency.alphaId].prices[i];
                                break;
                            }
                        }
                        
                        if (fifteenMinPrice !== null) {
                            fifteenMinuteHistory[currency.alphaId] = {
                                timestamp: fifteenMinutesAgo,
                                price: fifteenMinPrice
                            };
                        }
                    }
                });
            }
        }
        
        // è®¡ç®—15åˆ†é’Ÿæ¶¨è·Œå¹…
        function calculateFifteenMinuteChanges() {
            const now = Date.now();
            
            allCurrencies.forEach(currency => {
                if (fifteenMinuteHistory[currency.alphaId]) {
                    const fifteenMinPrice = fifteenMinuteHistory[currency.alphaId].price;
                    const currentPrice = parseFloat(currency.price);
                    
                    if (fifteenMinPrice > 0) {
                        currency.fifteenMinChange = ((currentPrice - fifteenMinPrice) / fifteenMinPrice) * 100;
                    } else {
                        currency.fifteenMinChange = 0;
                    }
                } else {
                    currency.fifteenMinChange = 0;
                }
            });
        }
        
        // è®°å½•ä¸Šæ¦œå†å²
        function recordRankingHistory() {
            const now = Date.now();
            const top20Currencies = allCurrencies.slice(0, TOP_RANK_COUNT);
            
            // è®°å½•å½“å‰æ—¶é—´ç‚¹çš„ä¸Šæ¦œå¸ç§
            const rankingRecord = {
                timestamp: now,
                currencies: top20Currencies.map(currency => ({
                    symbol: currency.symbol,
                    alphaId: currency.alphaId,
                    currencyLink: currency.currencyLink,
                    tradeCount: currency.tradeCount
                }))
            };
            
            rankingHistory.push(rankingRecord);
            
            // æ¸…ç†è¶…è¿‡15åˆ†é’Ÿçš„å†å²è®°å½•
            const retentionTime = now - RANKING_WINDOW_MINUTES * 60 * 1000;
            rankingHistory = rankingHistory.filter(record => record.timestamp >= retentionTime);
            
            // ä¿å­˜çŠ¶æ€åˆ°localStorage
            saveStateToStorage();
        }
        
        // è®¡ç®—ä¸Šæ¦œç»Ÿè®¡
        function calculateRankingStats() {
            const now = Date.now();
            const retentionTime = now - RANKING_WINDOW_MINUTES * 60 * 1000;
            
            // ç»Ÿè®¡æ¯ä¸ªå¸ç§çš„ä¸Šæ¦œæ¬¡æ•°å’Œæˆäº¤ç¬”æ•°æ€»å’Œ
            const rankingStats = {};
            
            // åˆå§‹åŒ–æ‰€æœ‰æœ‰äº¤æ˜“å¯¹çš„å¸ç§
            allCurrencies.forEach(currency => {
                rankingStats[currency.alphaId] = {
                    symbol: currency.symbol,
                    currencyLink: currency.currencyLink,
                    fifteenMinChange: currency.fifteenMinChange,
                    fifteenMinChangeArrow: currency.fifteenMinChangeArrow,
                    appearanceCount: 0,
                    totalTradeCount: 0
                };
            });
            
            // ç»Ÿè®¡ä¸Šæ¦œè®°å½•
            rankingHistory.forEach(record => {
                record.currencies.forEach(currency => {
                    if (rankingStats[currency.alphaId]) {
                        rankingStats[currency.alphaId].appearanceCount++;
                        rankingStats[currency.alphaId].totalTradeCount += currency.tradeCount;
                    }
                });
            });
            
            return Object.values(rankingStats)
                .filter(stat => stat.appearanceCount > 0)
                .sort((a, b) => b.appearanceCount - a.appearanceCount)
                .slice(0, TOP_RANK_COUNT);
        }
        
        // è·å–å‰20åå¸ç§çš„æˆäº¤ç¬”æ•°æ•°æ®ï¼ˆæ— é™é‡è¯•ï¼‰
        async function fetchTradeCounts() {
            const startTime = Date.now();
            addLog("å¼€å§‹è·å–å‰20åå¸ç§çš„æˆäº¤ç¬”æ•°æ•°æ®...");
            
            const top20Currencies = allCurrencies.slice(0, TOP_RANK_COUNT);
            const failedCurrencies = [];
            
            // ä¸ºæ¯ä¸ªå¸ç§çš„æ‰€æœ‰äº¤æ˜“å¯¹è·å–æˆäº¤ç¬”æ•°
            for (const currency of top20Currencies) {
                try {
                    let totalTradeCount = 0;
                    
                    // ä¸ºæ¯ä¸ªäº¤æ˜“å¯¹è·å–æ•°æ®
                    for (const tradingPair of currency.tradingPairs) {
                        addLog(`è·å–äº¤æ˜“å¯¹ ${tradingPair} çš„æˆäº¤ç¬”æ•°æ•°æ®...`);
                        
                        const response = await fetch(`https://www.binance.com/bapi/defi/v1/public/alpha-trade/klines?interval=15s&limit=5&symbol=${tradingPair}`);
                        
                        if (!response.ok) {
                            throw new Error(`æˆäº¤ç¬”æ•°APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.code !== "000000" || !data.success) {
                            throw new Error(`APIè¿”å›é”™è¯¯: ${data.message || data.messageDetail}`);
                        }
                        
                        if (!data.data || !Array.isArray(data.data)) {
                            throw new Error('æˆäº¤ç¬”æ•°APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                        }
                        
                        // è®¡ç®—5æ¡Kçº¿æ•°æ®çš„æˆäº¤ç¬”æ•°æ€»å’Œ
                        let pairTradeCount = 0;
                        for (const kline of data.data) {
                            const tradeCount = parseInt(kline[8]); // ç¬¬9ä¸ªå­—æ®µæ˜¯æˆäº¤ç¬”æ•°
                            if (!isNaN(tradeCount)) {
                                pairTradeCount += tradeCount;
                            }
                        }
                        
                        totalTradeCount += pairTradeCount;
                        addLog(`äº¤æ˜“å¯¹ ${tradingPair} 5æ¡Kçº¿æˆäº¤ç¬”æ•°æ€»å’Œ: ${pairTradeCount}`);
                    }
                    
                    currency.tradeCount = totalTradeCount;
                    addLog(`å¸ç§ ${currency.symbol} æ€»æˆäº¤ç¬”æ•°: ${totalTradeCount}`);
                    
                } catch (error) {
                    addLog(`è·å–å¸ç§ ${currency.symbol} æˆäº¤ç¬”æ•°å¤±è´¥: ${error.message}`);
                    failedCurrencies.push(currency);
                }
            }
            
            // æ— é™é‡è¯•å¤±è´¥çš„å¸ç§
            if (failedCurrencies.length > 0) {
                addLog(`æœ‰${failedCurrencies.length}ä¸ªå¸ç§çš„æ•°æ®è·å–å¤±è´¥ï¼Œå¼€å§‹æ— é™é‡è¯•...`);
                await retryFailedTradeCounts(failedCurrencies);
            }
            
            const endTime = Date.now();
            const duration = (endTime - startTime) / 1000;
            addLog(`å‰20åå¸ç§æˆäº¤ç¬”æ•°æ•°æ®è·å–å®Œæˆï¼Œæ€»è€—æ—¶: ${duration.toFixed(2)}ç§’`);
            
            return duration;
        }
        
        // æ— é™é‡è¯•å¤±è´¥çš„æˆäº¤ç¬”æ•°è·å–
        async function retryFailedTradeCounts(failedCurrencies) {
            let retryCount = 0;
            
            while (failedCurrencies.length > 0) {
                retryCount++;
                addLog(`ç¬¬${retryCount}æ¬¡é‡è¯•å¤±è´¥çš„å¸ç§æ•°æ®...`);
                
                const stillFailed = [];
                
                for (const currency of failedCurrencies) {
                    try {
                        let totalTradeCount = 0;
                        
                        for (const tradingPair of currency.tradingPairs) {
                            const response = await fetch(`https://www.binance.com/bapi/defi/v1/public/alpha-trade/klines?interval=15s&limit=5&symbol=${tradingPair}`);
                            
                            if (!response.ok) {
                                throw new Error(`æˆäº¤ç¬”æ•°APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.code !== "000000" || !data.success) {
                                throw new Error(`APIè¿”å›é”™è¯¯: ${data.message || data.messageDetail}`);
                            }
                            
                            if (!data.data || !Array.isArray(data.data)) {
                                throw new Error('æˆäº¤ç¬”æ•°APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                            }
                            
                            // è®¡ç®—5æ¡Kçº¿æ•°æ®çš„æˆäº¤ç¬”æ•°æ€»å’Œ
                            let pairTradeCount = 0;
                            for (const kline of data.data) {
                                const tradeCount = parseInt(kline[8]);
                                if (!isNaN(tradeCount)) {
                                    pairTradeCount += tradeCount;
                                }
                            }
                            
                            totalTradeCount += pairTradeCount;
                        }
                        
                        currency.tradeCount = totalTradeCount;
                        addLog(`é‡è¯•æˆåŠŸ: å¸ç§ ${currency.symbol} æ€»æˆäº¤ç¬”æ•°: ${totalTradeCount}`);
                        
                    } catch (error) {
                        addLog(`é‡è¯•å¤±è´¥: å¸ç§ ${currency.symbol} - ${error.message}`);
                        stillFailed.push(currency);
                    }
                }
                
                failedCurrencies = stillFailed;
                
                if (failedCurrencies.length > 0) {
                    addLog(`ç­‰å¾…2ç§’åç»§ç»­é‡è¯•...`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            addLog(`æ‰€æœ‰å¸ç§çš„æˆäº¤ç¬”æ•°æ•°æ®è·å–æˆåŠŸ`);
        }
        
        // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
        function updateApiStatus(connected, message = '') {
            const apiStatusDot = document.getElementById('api-status-dot');
            const apiStatusText = document.getElementById('api-status-text');
            
            if (connected) {
                apiStatusDot.className = 'api-status-dot connected';
                apiStatusText.textContent = 'APIçŠ¶æ€: å·²è¿æ¥';
                apiStatusText.style.color = '#2e7d32';
            } else {
                apiStatusDot.className = 'api-status-dot';
                apiStatusText.textContent = message || 'APIçŠ¶æ€: è¿æ¥å¤±è´¥';
                apiStatusText.style.color = '#c62828';
            }
        }
        
        // åˆå§‹åŒ–ä»·æ ¼å†å²è®°å½•
        function initializePriceHistory() {
            priceHistory = {};
            const now = Date.now();
            
            allCurrencies.forEach(currency => {
                priceHistory[currency.alphaId] = {
                    timestamps: [now],
                    prices: [parseFloat(currency.price)]
                };
            });
        }
        
        // å¼€å§‹ç›‘æ§
        function startMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            document.querySelector('.status-dot').classList.add('active');
            document.getElementById('status-text').textContent = 'ç›‘æ§è¿è¡Œä¸­';
            
            addLog("å¼€å§‹å®æ—¶ç›‘æ§...");
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡æ•°æ®
            updatePrices();
        }
        
        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.querySelector('.status-dot').classList.remove('active');
            document.getElementById('status-text').textContent = 'ç›‘æ§å·²åœæ­¢';
            
            clearInterval(monitoringInterval);
            addLog("åœæ­¢å®æ—¶ç›‘æ§");
            
            // ä¿å­˜çŠ¶æ€
            saveStateToStorage();
        }
        
        // æ›´æ–°ä»·æ ¼æ•°æ®
        async function updatePrices() {
            if (!isMonitoring) return;
            
            try {
                const cycleStartTime = Date.now();
                addLog("å¼€å§‹æ›´æ–°ä»·æ ¼æ•°æ®...");
                
                // è°ƒç”¨APIè·å–æœ€æ–°æ•°æ®
                const response = await fetch('https://www.binance.com/bapi/defi/v1/public/wallet-direct/buw/wallet/cex/alpha/all/token/list');
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // æ£€æŸ¥APIè¿”å›çš„æ•°æ®ç»“æ„
                if (!data.data || !Array.isArray(data.data)) {
                    throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                const now = Date.now();
                
                // æ›´æ–°å¸ç§ä»·æ ¼ - åªæ›´æ–°æœ‰äº¤æ˜“å¯¹çš„å¸ç§
                data.data.forEach(apiCurrency => {
                    // åªå¤„ç†æœ‰äº¤æ˜“å¯¹çš„å¸ç§
                    if (!tradingPairsData[apiCurrency.alphaId] || tradingPairsData[apiCurrency.alphaId].length === 0) {
                        return;
                    }
                    
                    const existingCurrency = allCurrencies.find(c => c.alphaId === apiCurrency.alphaId);
                    
                    if (existingCurrency) {
                        const newPrice = apiCurrency.price || existingCurrency.price;
                        
                        // æ›´æ–°å½“å‰ä»·æ ¼
                        existingCurrency.price = newPrice;
                        
                        // è®°å½•ä»·æ ¼å†å²ï¼ˆä½¿ç”¨IDä½œä¸ºé”®ï¼‰
                        if (!priceHistory[existingCurrency.alphaId]) {
                            priceHistory[existingCurrency.alphaId] = {
                                timestamps: [],
                                prices: []
                            };
                        }
                        
                        // æ·»åŠ æ–°ä»·æ ¼æ•°æ®
                        priceHistory[existingCurrency.alphaId].timestamps.push(now);
                        priceHistory[existingCurrency.alphaId].prices.push(parseFloat(newPrice));
                        
                        // æ¸…ç†è¶…è¿‡30åˆ†é’Ÿçš„å†å²æ•°æ®
                        const retentionTime = now - DATA_RETENTION_MINUTES * 60 * 1000;
                        const validIndices = [];
                        
                        for (let i = 0; i < priceHistory[existingCurrency.alphaId].timestamps.length; i++) {
                            if (priceHistory[existingCurrency.alphaId].timestamps[i] >= retentionTime) {
                                validIndices.push(i);
                            }
                        }
                        
                        if (validIndices.length > 0) {
                            priceHistory[existingCurrency.alphaId].timestamps = validIndices.map(i => priceHistory[existingCurrency.alphaId].timestamps[i]);
                            priceHistory[existingCurrency.alphaId].prices = validIndices.map(i => priceHistory[existingCurrency.alphaId].prices[i]);
                        }
                        
                        // è®¡ç®—1åˆ†é’Ÿå’Œ3åˆ†é’Ÿæ¶¨å¹…
                        calculatePriceChanges(existingCurrency);
                    }
                });
                
                // æŒ‰3åˆ†é’Ÿæ¶¨å¹…é™åºæ’åˆ—
                allCurrencies.sort((a, b) => b.threeMinChange - a.threeMinChange);
                
                addLog("ä»·æ ¼æ•°æ®æ›´æ–°å®Œæˆï¼Œå¼€å§‹è·å–å‰20åæˆäº¤ç¬”æ•°...");
                
                // è·å–å‰20åå¸ç§çš„æˆäº¤ç¬”æ•°ï¼ˆæ— é™é‡è¯•ç›´åˆ°å…¨éƒ¨æˆåŠŸï¼‰
                const tradeCountDuration = await fetchTradeCounts();
                
                // æ›´æ–°15åˆ†é’Ÿä»·æ ¼å†å²
                updateFifteenMinuteHistory();
                
                // è®¡ç®—15åˆ†é’Ÿæ¶¨è·Œå¹…
                calculateFifteenMinuteChanges();
                
                // æ›´æ–°ç®­å¤´æŒ‡ç¤º - ä½¿ç”¨æ–°çš„ç®­å¤´æ ·å¼
                updateChangeArrows();
                
                // è®°å½•ä¸Šæ¦œå†å²
                recordRankingHistory();
                
                // æ£€æŸ¥æ¶¨å¹…æé†’
                checkPriceAlerts();
                
                // æ›´æ–°æ˜¾ç¤º
                renderCurrencyTable();
                updateRankingTable();
                updateTime();
                updateApiStatus(true);
                apiRetryCount = 0;
                
                const cycleEndTime = Date.now();
                const totalCycleDuration = (cycleEndTime - cycleStartTime) / 1000;
                
                addLog(`æœ¬è½®æ•°æ®æ›´æ–°å®Œæˆï¼Œæ€»è€—æ—¶: ${totalCycleDuration.toFixed(2)}ç§’ (ä»·æ ¼æ›´æ–°: ${(totalCycleDuration - tradeCountDuration).toFixed(2)}ç§’, æˆäº¤ç¬”æ•°: ${tradeCountDuration.toFixed(2)}ç§’)`);
                
                // è®¾ç½®ä¸‹ä¸€è½®æ›´æ–°ï¼ˆç¡®ä¿å‰20åéƒ½è·å–å®Œæˆäº¤ç¬”æ•°åå†å¼€å§‹ä¸‹ä¸€è½®ï¼‰
                if (isMonitoring) {
                    monitoringInterval = setTimeout(updatePrices, 5000);
                }
                
            } catch (error) {
                console.error('æ›´æ–°ä»·æ ¼æ•°æ®å¤±è´¥:', error);
                apiRetryCount++;
                const displayCount = Math.min(apiRetryCount, MAX_RETRY_DISPLAY);
                updateApiStatus(false, `APIè¿æ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... (${displayCount}${apiRetryCount > MAX_RETRY_DISPLAY ? '+' : ''})`);
                
                addLog(`æ›´æ–°ä»·æ ¼æ•°æ®å¤±è´¥: ${error.message}`);
                
                // æ— é™é‡è¯•ï¼Œç­‰å¾…2ç§’åå†æ¬¡å°è¯•
                if (isMonitoring) {
                    setTimeout(updatePrices, 2000);
                }
            }
        }
        
        // è®¡ç®—ä»·æ ¼å˜åŒ–
        function calculatePriceChanges(currency) {
            const now = Date.now();
            const oneMinuteAgo = now - 60 * 1000;
            const threeMinutesAgo = now - 3 * 60 * 1000;
            const currentPrice = parseFloat(currency.price);
            
            let oneMinPrice = null;
            let threeMinPrice = null;
            
            // æŸ¥æ‰¾1åˆ†é’Ÿå‰çš„ä»·æ ¼
            if (priceHistory[currency.alphaId]) {
                for (let i = priceHistory[currency.alphaId].timestamps.length - 1; i >= 0; i--) {
                    if (priceHistory[currency.alphaId].timestamps[i] <= oneMinuteAgo) {
                        oneMinPrice = priceHistory[currency.alphaId].prices[i];
                        break;
                    }
                }
            }
            
            // æŸ¥æ‰¾3åˆ†é’Ÿå‰çš„ä»·æ ¼
            if (priceHistory[currency.alphaId]) {
                for (let i = priceHistory[currency.alphaId].timestamps.length - 1; i >= 0; i--) {
                    if (priceHistory[currency.alphaId].timestamps[i] <= threeMinutesAgo) {
                        threeMinPrice = priceHistory[currency.alphaId].prices[i];
                        break;
                    }
                }
            }
            
            // è®¡ç®—æ¶¨å¹…ç™¾åˆ†æ¯”
            if (oneMinPrice !== null && oneMinPrice > 0) {
                currency.oneMinChange = ((currentPrice - oneMinPrice) / oneMinPrice) * 100;
            } else {
                currency.oneMinChange = 0;
            }
            
            if (threeMinPrice !== null && threeMinPrice > 0) {
                currency.threeMinChange = ((currentPrice - threeMinPrice) / threeMinPrice) * 100;
            } else {
                currency.threeMinChange = 0;
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('trading-pairs-count').textContent = allCurrencies.length;
        }
        
        // æ¸²æŸ“å¸ç§è¡¨æ ¼ï¼ˆåªæ˜¾ç¤ºå‰20åï¼‰
        function renderCurrencyTable() {
            const tableBody = document.getElementById('currency-table-body');
            
            // æ¸…ç©ºè¡¨æ ¼
            tableBody.innerHTML = '';
            
            // åªæ˜¾ç¤ºå‰20å
            const top20Currencies = allCurrencies.slice(0, TOP_RANK_COUNT);
            
            // å¡«å……è¡¨æ ¼æ•°æ®
            top20Currencies.forEach((currency, index) => {
                const row = document.createElement('tr');
                
                const oneMinClass = currency.oneMinChange >= 0 ? 'positive' : 'negative';
                const threeMinClass = currency.threeMinChange >= 0 ? 'positive' : 'negative';
                
                const oneMinSign = currency.oneMinChange >= 0 ? '+' : '';
                const threeMinSign = currency.threeMinChange >= 0 ? '+' : '';
                
                // åˆ›å»ºå¸ç§åç§°é“¾æ¥
                const symbolLink = currency.currencyLink !== '#' ? 
                    `<a href="${currency.currencyLink}" target="_blank" class="currency-link">${currency.symbol}</a>` : 
                    currency.symbol;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${symbolLink}</td>
                    <td>${parseFloat(currency.price).toFixed(14)}</td>
                    <td class="${oneMinClass}">${oneMinSign}${currency.oneMinChange.toFixed(4)}%</td>
                    <td class="${threeMinClass}">${threeMinSign}${currency.threeMinChange.toFixed(4)}%${currency.threeMinChangeArrow}</td>
                    <td>${currency.tradeCount}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // æ›´æ–°ä¸Šæ¦œç»Ÿè®¡è¡¨æ ¼
        function updateRankingTable() {
            const tableBody = document.getElementById('ranking-table-body');
            const rankingStats = calculateRankingStats();
            
            // æ¸…ç©ºè¡¨æ ¼
            tableBody.innerHTML = '';
            
            // å¡«å……è¡¨æ ¼æ•°æ®
            rankingStats.forEach((stat, index) => {
                const row = document.createElement('tr');
                
                const fifteenMinClass = stat.fifteenMinChange >= 0 ? 'positive' : 'negative';
                const fifteenMinSign = stat.fifteenMinChange >= 0 ? '+' : '';
                
                // åˆ›å»ºå¸ç§åç§°é“¾æ¥
                const symbolLink = stat.currencyLink !== '#' ? 
                    `<a href="${stat.currencyLink}" target="_blank" class="currency-link">${stat.symbol}</a>` : 
                    stat.symbol;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${symbolLink}</td>
                    <td class="${fifteenMinClass}">${fifteenMinSign}${stat.fifteenMinChange.toFixed(4)}%${stat.fifteenMinChangeArrow}</td>
                    <td>${stat.appearanceCount}</td>
                    <td>${stat.totalTradeCount}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // æ›´æ–°ç»Ÿè®¡æ—¶é—´
            const now = new Date();
            document.getElementById('ranking-update-time').textContent = now.toLocaleString();
        }
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            document.getElementById('update-time').textContent = now.toLocaleString();
        }
    </script>
</body>
</html>
